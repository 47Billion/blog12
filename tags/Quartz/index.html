<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tag: Quartz | 47Billion Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="47Billion Blog">
<meta property="og:url" content="http://47billion.com/blog/blog/tags/Quartz/">
<meta property="og:site_name" content="47Billion Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="47Billion Blog">
<meta name="twitter:description">

  
  
    <link rel="icon" href="/favicon.png">
  
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <!--<link href="//fonts.useso.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css">-->
  <!--<link href='//fonts.useso.com/css?family=Open+Sans:300,600' rel='stylesheet' type='text/css'>-->
  <link rel="stylesheet" href="/blog/css/style.css" type="text/css">

  <link rel="stylesheet" href="/blog/css/slicknav.css" type="text/css">

  
<!-- Google Analytics -->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60258456-2', 'auto');
    ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <a href="http://www.47billion.com/" class="logo">47Billion Blog</a>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
          
      </nav>


      <nav id="sub-nav">
          <div id="search-form-wrap">
              <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://47billion.com/blog"></form>
          </div>
          <a id="nav-search-btn" class="nav-icon" title="Search"></a>
          <div class="headsociallink">
              <a href="https://www.facebook.com/47Billion" target="_blank"><i class="fa fa-facebook-square"></i></a>
              <a href="https://twitter.com/47billion" target="_blank"><i class="fa fa-twitter-square"></i></a>
              <a href="https://twitter.com/47billion" target="_blank"><i class="fa fa-linkedin-square"></i></a>
              <a href="https://plus.google.com/102587598432325227811"><i class="fa fa-google-plus-square"></i></a>
              <a href="mailto:info@47billion.com"><i class="fa fa-envelope"></i></a>
          </div>
      </nav>
    </div>
  </div>
</header>
      <nav id="mobile-nav" class="off">
  
  <div id="search-form-wrap-mobile">
    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://47billion.com/blog"></form>
  </div>
</nav>
      <div class="outer">
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Digital-World/">Digital World</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Technology/">Technology</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Technology/Java/">Java</a><span class="category-list-count">1</span></li></ul></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/07/">July 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/02/">February 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2013/09/">September 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2013/01/">January 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2012/03/">March 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2011/09/">September 2011</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Aspect-Oriented-Programming/">Aspect Oriented Programming</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/AspectJ/">AspectJ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Delayed-Job/">Delayed Job</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Deployable/">Deployable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Design-Pattern/">Design Pattern</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Digital-Signage/">Digital Signage</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Embedded-Jetty/">Embedded Jetty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Guice/">Guice</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/JAX-RS/">JAX-RS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Java/">Java</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Java-Annotation/">Java Annotation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/JavaScript/">JavaScript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Jersey/">Jersey</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Jesque/">Jesque</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Jetty/">Jetty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Python/">Python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Quartz/">Quartz</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/REST/">REST</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Redis/">Redis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Resque/">Resque</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Resteasy/">Resteasy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Security/">Security</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Spring/">Spring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/jsr250/">jsr250</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
</aside>
        
        <section id="main">
  
    <article id="post-jesque-guice-binding" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2013/09/18/jesque-guice-binding/" class="article-date">
  <time datetime="2013-09-18T11:14:41.000Z" itemprop="datePublished">Sep 18 2013</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/Technology/">Technology</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2013/09/18/jesque-guice-binding/">Jesque-Guice binding</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In our Java stack, we use <a href="https://code.google.com/p/google-guice/" target="_blank" rel="external">Guice</a> IOC library quite heavily. We are kind of smitten with it. Now, when we needed a task queue to process our background jobs, we settled with <a href="https://github.com/gresrun/jesque" target="_blank" rel="external">Jesque</a> which is a port of Github’s Resque project, and runs on Redis which was already part of our stack. In the process, we also added <a href="http://anismiles.wordpress.com/2013/09/02/delayed-jobs-with-jesque/" target="_blank" rel="external">delayed task functionality</a> to this. </p>
<h2 id="Problem">Problem</h2>
<p>Anyways, the problem we were facing was with Injecting Guice dependencies into Jesque workers. Our workers performed heavy operations and at times had to read-write from DB, or speak with other services. </p>
<p>Jesque uses Java reflection APIs to instantiate and run its workers (which are Runnable classes) and so, it becomes very difficult to inject Guice managed objects and services into Jesque workers. </p>
<p>We started the hacky-and-ugly way by creating static references to relevant services that our workers needed. if it were for few services, this would have worked, but our workers kept growing in features and reach, and after a while the whole code base was stinking. We had to do something about it. Something elegant!  </p>
<h2 id="Solution">Solution</h2>
<p>So, we created Jesque Guice binding project. You can annotate your worker classes, and Guice will then discover, register and start them. Let me show you some code.</p>
<p>First, let’s create an ExampleWorker. You have to remember that the Worker must <u>implement Runnable</u> interface, and it must be annotated with <u>@Worker</u> which Guice uses for discovery and binding. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ExampleWorker</span></div><div class="line"></div><div class="line"><span class="annotation">@Worker</span>(job = &quot;ExampleJob&quot;,                 <span class="comment">// job name</span></div><div class="line">        queues = { &quot;EXP_QUEUE&quot; },           <span class="comment">// queue names</span></div><div class="line">        enabled = <span class="keyword">true</span>,                     <span class="comment">// enabled</span></div><div class="line">        count = <span class="number">1</span>,                          <span class="comment">// 1 instance of this worker running</span></div><div class="line">        events = { WorkerEvent.JOB_SUCCESS, WorkerEvent.WORKER_START }, <span class="comment">// Events to listen to</span></div><div class="line">        listener = EchoListener.class      <span class="comment">// WorkerEventListener</span></div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleWorker</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</div><div class="line">    <span class="comment">// LOG</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(ExampleWorker.class);</div><div class="line"></div><div class="line">    <span class="comment">// Note: Only field level injection would work!</span></div><div class="line">    <span class="annotation">@Inject</span></div><div class="line">    ExampleService service;</div><div class="line"></div><div class="line">    String arg1;</div><div class="line">    String arg2;</div><div class="line"></div><div class="line">    <span class="comment">// Must keep an empty constructor for Guice to discover this</span></div><div class="line">    <span class="keyword">public</span> <span class="title">ExampleWorker</span>() {</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="title">ExampleWorker</span>(String arg1, String arg2) {</div><div class="line">        <span class="keyword">this</span>.arg1 = arg1;</div><div class="line">        <span class="keyword">this</span>.arg2 = arg2;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">        LOG.info(&quot;Running worker={}, with arg1={}, arg2={}&quot;, <span class="keyword">new</span> Object[] { getClass(), arg1, arg2 });</div><div class="line">        <span class="comment">// calling service</span></div><div class="line">        service.serve();</div><div class="line">    }</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<p><strong><u>@Worker</u></strong> attributes let you control the behavior. The above worker, ExampleWorker, listens to <strong><u>EXP_QUEUE</u></strong> queue, accepts Jobs by name <strong><u>ExampleJob</u></strong>, has an WorkerEventListener defined by Guice Managed class <strong><u>EchoListener</u></strong> which listens to WorkerEvent <strong>JOB_SUCCESS</strong> and <strong>WORKER_START</strong>. There is only <strong>ONE</strong> instance of this worker running. </p>
<p>Note: ExampleWorker has been <u>field @Injected</u> with <strong>ExampleService</strong>. Please remember, that </p>
<ul>
<li><u>Only field @Inject</u> will work with Workers, because Jesque uses constructors to pass Job arguments. </li>
<li>Also, you <u>must keep an empty constructor</u> around so as to let Guice discover this worker. </li>
</ul>
<p>Now, since we have added a Listener, we must define it. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// EchoListener</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoListener</span> <span class="keyword">implements</span> <span class="title">WorkerListener</span> </span>{</div><div class="line">    <span class="comment">// LOG</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(EchoListener.class);</div><div class="line"></div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span>(WorkerEvent event, Worker worker, String queue, Job job, Object runner,</div><div class="line">            Object result, Exception ex) {</div><div class="line">        LOG.info(&quot;onEvent ==&gt;&gt; queue={}, event={}&quot;, <span class="keyword">new</span> Object[] { queue, event });</div><div class="line">    }</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<p>For the sake of demonstration, this has been kept very minimal. But, mind you, you can @Inject any Guice managed objects into this, using <u>constructor and/or field injection</u>.  </p>
<p>Now, let’s define the ExampleService that we want to @Inject into our worker. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ExampleService</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleService</span> </span>{</div><div class="line">    <span class="javadoc">/** The Constant LOG. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(ExampleService.class);</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serve</span>() {</div><div class="line">        LOG.info(&quot;Heya! I am not here to serve, just to show you how injection works.&quot;);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>Wonderful! Let’s now bind these all together in a GuiceModule. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ExampleModule</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleModule</span> <span class="keyword">extends</span> <span class="title">AbstractModule</span> </span>{</div><div class="line"></div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span>() {</div><div class="line">        <span class="comment">// Jesque Guice</span></div><div class="line">        install(<span class="keyword">new</span> JesqueModule());</div><div class="line"></div><div class="line">        <span class="comment">// Jesque Client</span></div><div class="line">        Config config = <span class="keyword">new</span> ConfigBuilder().withHost(&quot;localhost&quot;).withPort(<span class="number">6379</span>).withDatabase(<span class="number">0</span>).build();</div><div class="line">        bind(Config.class).toInstance(config);</div><div class="line">        bind(Client.class).toInstance(<span class="keyword">new</span> ClientImpl(config));</div><div class="line"></div><div class="line">        <span class="comment">// Worker</span></div><div class="line">        bind(ExampleWorker.class).asEagerSingleton(); <span class="comment">// Must be singleton</span></div><div class="line">        <span class="comment">// WorkerEventListener</span></div><div class="line">        bind(EchoListener.class).in(Scopes.SINGLETON);</div><div class="line">        <span class="comment">// Worker Executor (This is where they actually run)</span></div><div class="line">        bind(WorkerExecutor.class).to(SimpleThreadBasedWorkerExecutor.class);</div><div class="line">        <span class="comment">// Service (will be injected into workers)</span></div><div class="line">        bind(ExampleService.class).asEagerSingleton();</div><div class="line">    }</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<p>Here, first we install JesqueModule, and then bind other objects. </p>
<ul>
<li>Bind Jesque config and client.</li>
<li>Bind Worker, Lister, Service etc. </li>
</ul>
<p>You will notice we have also bound <u>WorkerExecutor</u>. This interface accepts <strong><u>net.greghaines.jesque.worker.Worker</u></strong> instance and runs that on a thread. Jesque-Guice comes with 2 simple implementations:</p>
<p>1. <u>SimpleThreadBasedWorkerExecutor</u> which run each net.greghaines.jesque.worker.Worker on an unmanaged separate thread, and<br>2. <u>CachedThreadPoolBasedWorkerExecutor</u> which creates a CachedThreadPool where net.greghaines.jesque.worker.Worker is run. </p>
<p>You can implement your own strategy or provide your own ExecutorService. </p>
<h2 id="Run">Run</h2>
<p>Now we have everything, let’s run it then. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Main</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>{</div><div class="line">    <span class="javadoc">/** The Constant LOG. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(Main.class);</div><div class="line"></div><div class="line">    <span class="javadoc">/**</span></div><div class="line">     *<span class="javadoctag"> @param</span> args</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) {</div><div class="line">        Injector injector = Guice.createInjector(Stage.DEVELOPMENT, <span class="keyword">new</span> Module[] { <span class="keyword">new</span> ExampleModule() });</div><div class="line"></div><div class="line">        <span class="comment">// Get Jesque client</span></div><div class="line">        Client client = (Client) injector.getInstance(Client.class);</div><div class="line">        LOG.info(&quot;Publish jobs&quot;);</div><div class="line">        <span class="comment">// Push jobs</span></div><div class="line">        client.enqueue(&quot;EXP_QUEUE&quot;, <span class="keyword">new</span> Job(&quot;ExampleJob&quot;, &quot;hello&quot;, &quot;job1&quot;));</div><div class="line">        client.enqueue(&quot;EXP_QUEUE&quot;, <span class="keyword">new</span> Job(&quot;ExampleJob&quot;, &quot;hello&quot;, &quot;job2&quot;));</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>You should see,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">// Job - <span class="number">1</span></div><div class="line">DEBUG c.s.commons.jesque.GuiceAwareWorker - Injecting dependencies into worker instance = com.strumsoft.commons.jesque.example.ExampleWorker@<span class="number">6</span>b754699</div><div class="line">DEBUG c.s.commons.jesque.GuiceAwareWorker - Delegating to run worker instance = com.strumsoft.commons.jesque.example.ExampleWorker@<span class="number">6</span>b754699</div><div class="line">INFO  c.s.c.jesque.example.ExampleWorker - Running worker=class com.strumsoft.commons.jesque.example.ExampleWorker, with arg1=hello, arg2=job1</div><div class="line">INFO  c.s.c.jesque.example.ExampleService - Heya! I am not here to serve, just to show you how injection works.</div><div class="line">INFO  c.s.c.jesque.example.EchoListener - onEvent ==&gt;&gt; queue=EXP_QUEUE, event=JOB_SUCCESS</div><div class="line"></div><div class="line">// Job -<span class="number">2</span></div><div class="line">DEBUG c.s.commons.jesque.GuiceAwareWorker - Injecting dependencies into worker instance = com.strumsoft.commons.jesque.example.ExampleWorker@<span class="number">6602</span>e323</div><div class="line">DEBUG c.s.commons.jesque.GuiceAwareWorker - Delegating to run worker instance = com.strumsoft.commons.jesque.example.ExampleWorker@<span class="number">6602</span>e323</div><div class="line">INFO  c.s.c.jesque.example.ExampleWorker - Running worker=class com.strumsoft.commons.jesque.example.ExampleWorker, with arg1=hello, arg2=job2</div><div class="line">INFO  c.s.c.jesque.example.ExampleService - Heya! I am not here to serve, just to show you how injection works.</div><div class="line">INFO  c.s.c.jesque.example.EchoListener - onEvent ==&gt;&gt; queue=EXP_QUEUE, event=JOB_SUCCESS</div></pre></td></tr></table></figure>

<p>Works… eh? :)</p>
<p>You can grab the project source at github <a href="https://github.com/anismiles/jesque-guice/" target="_blank" rel="external">https://github.com/anismiles/jesque-guice</a> Give it a try. I hope this will help some of you folks. Share your thoughts with me. </p>
<p>Happy hacking!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://47billion.com/blog/2013/09/18/jesque-guice-binding/" data-id="rc0peuuid8137tlw" class="article-share-link">Share</a>
      
        <a href="http://47billion.com/blog/2013/09/18/jesque-guice-binding/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Guice/">Guice</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Quartz/">Quartz</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Redis/">Redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Resque/">Resque</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-delayed-jobs-with-jesque" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2013/09/02/delayed-jobs-with-jesque/" class="article-date">
  <time datetime="2013-09-02T11:36:43.000Z" itemprop="datePublished">Sep 2 2013</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/Technology/">Technology</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2013/09/02/delayed-jobs-with-jesque/">Delayed Jobs with Jesque</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/gresrun/jesque" title="Jesque" target="_blank" rel="external">Jesque</a> is an interesting project. It’s a Java port of <a href="https://github.com/resque/resque" title="Resque" target="_blank" rel="external">Github’s Resque</a> task queue library. Works on top of Redis. It is fast. It eats less. And doesn’t need a lot of maintenance, as long long your Redis is okay, you are okay! We have been happily using this in production for a while.</p>
<h2 id="Problem">Problem</h2>
<p>And then, we encountered a need for delayed jobs. We needed an ability to execute jobs in future with deterministic delay. We had 2 options:</p>
<p>1. Either, schedule these delayed jobs in <a href="http://quartz-scheduler.org/" title="Quartz" target="_blank" rel="external">Quartz</a> - that was okay because we already had been using Quartz - and then, once Quartz jobs get fired, they publish a Task into Jesque, and let the workers handle the rest. (<span style="text-decoration:underline;">This was too contrived to implement, and would have become maintenance/reporting nightmare!</span>)</p>
<p>2. We extend Jesque to support delayed jobs inherently.</p>
<h2 id="Solution">Solution</h2>
<p>We decided to go with option-2, and started exploring Redis datasets. Turned out, <a href="http://redis.io/commands#sorted_set" target="_blank" rel="external">ZSET</a> was all that we needed.</p>
<p>Jesque uses Redis <a href="http://redis.io/commands#list" target="_blank" rel="external">LIST</a> for job storage, workers keep polling the list, and <a href="http://redis.io/commands/lpop" target="_blank" rel="external">LPOP</a>s tasks from the LIST.</p>
<p>This is what we ended up doing:</p>
<p>When <u>adding a delayed job</u>,</p>
<p>1. Calculate future timestamp when the job should run,<br>2. Use that timestamp as SCORE to ZSET entry.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">long</span> delay = <span class="number">10</span>; <span class="comment">//sec</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">long</span> future = System.currentTimeMillis() + (delay * <span class="number">1000</span>); <span class="comment">// future</span></div><div class="line">jedis.zadd(QUEUE, future, jobInfo); </div><div class="line"></div><div class="line"><span class="comment">// Redis</span></div><div class="line"><span class="comment">// ZADD &lt;queue&gt; &lt;future&gt; &lt;job-information&gt;</span></div></pre></td></tr></table></figure>

<p>On the other hand, <u>Workers’ poll logic was updated</u>. For Delayed queues, </p>
<p>1. Check if there are any items with SCORE between -INF and now,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"><span class="keyword">final</span> Set&lt;String&gt; tasks = jedis.zrangeByScore(QUEUE, -<span class="number">1</span>, now, <span class="number">0</span>, <span class="number">1</span>);</div></pre></td></tr></table></figure>

<p>If tasks are non-empty, try to grab one to execute. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="keyword">null</span> != tasks &amp;&amp; !tasks.isEmpty()) {</div><div class="line">    String task = tasks.iterator().next();</div><div class="line">    <span class="comment">// try to acquire this task</span></div><div class="line">    <span class="keyword">if</span> (jedis.zrem(QUEUE, task) == <span class="number">1</span>) {</div><div class="line">         <span class="keyword">return</span> task; <span class="comment">// Return</span></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>This way, we ensure that no 2 workers would grab the same task to execute. </p>
<p>Also, an important point to note here is that - You <u><strong>don’t have to change your existing workers</strong></u> or redo new workers in any way. Just bind them to a Delayed Queue, and start publishing delayed tasks. </p>
<h2 id="Example">Example</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DelayedJobTest.java</span></div><div class="line"><span class="keyword">package</span> net.greghaines.jesque;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.greghaines.jesque.utils.JesqueUtils.entry;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.greghaines.jesque.utils.JesqueUtils.map;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"></div><div class="line"><span class="keyword">import</span> net.greghaines.jesque.client.Client;</div><div class="line"><span class="keyword">import</span> net.greghaines.jesque.client.ClientPoolImpl;</div><div class="line"><span class="keyword">import</span> net.greghaines.jesque.worker.Worker;</div><div class="line"><span class="keyword">import</span> net.greghaines.jesque.worker.WorkerImpl;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayedJobTest</span> </span>{</div><div class="line"></div><div class="line">    <span class="annotation">@SuppressWarnings</span>(&quot;unchecked&quot;)</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) <span class="keyword">throws</span> InterruptedException {</div><div class="line">        <span class="comment">// Queue name</span></div><div class="line">        <span class="keyword">final</span> String QUEUE = &quot;fooDelayed&quot;;</div><div class="line"></div><div class="line">        <span class="comment">// Config</span></div><div class="line">        <span class="keyword">final</span> Config config = <span class="keyword">new</span> ConfigBuilder().withHost(&quot;localhost&quot;).withPort(<span class="number">6379</span>).withDatabase(<span class="number">0</span>).build();</div><div class="line"></div><div class="line">        <span class="comment">// Client</span></div><div class="line">        <span class="keyword">final</span> Client client = <span class="keyword">new</span> ClientPoolImpl(config, <span class="keyword">new</span> JedisPool(&quot;localhost&quot;));</div><div class="line">        <span class="keyword">long</span> delay = <span class="number">10</span>; <span class="comment">// seconds</span></div><div class="line">        <span class="keyword">long</span> future = System.currentTimeMillis() + (delay * <span class="number">1000</span>); <span class="comment">// Future timestamp</span></div><div class="line"></div><div class="line">        <span class="comment">// Enqueue job</span></div><div class="line">        client.delayedEnqueue(QUEUE, </div><div class="line">                <span class="keyword">new</span> Job(</div><div class="line">                        TestJob.class.getSimpleName(), </div><div class="line">                        <span class="keyword">new</span> Object[] {&quot;HELLO&quot;, &quot;WORLD&quot; } <span class="comment">// arguments</span></div><div class="line">                ), </div><div class="line">                future);</div><div class="line">        <span class="comment">// End</span></div><div class="line">        client.end();</div><div class="line"></div><div class="line">        <span class="comment">// Worker</span></div><div class="line">        <span class="keyword">final</span> Worker worker = <span class="keyword">new</span> WorkerImpl(config, Arrays.asList(QUEUE), map(entry(TestJob.class.getSimpleName(), TestJob.class)));</div><div class="line">        <span class="keyword">final</span> Thread workerThread = <span class="keyword">new</span> Thread(worker);</div><div class="line">        workerThread.start(); <span class="comment">// start</span></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>And, this is the TestJob,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// TestJob.java</span></div><div class="line"><span class="keyword">package</span> net.greghaines.jesque;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJob</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</div><div class="line">    <span class="keyword">final</span> String arg1;</div><div class="line">    <span class="keyword">final</span> String arg2;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="title">TestJob</span>(String arg1, String arg2) {</div><div class="line">        <span class="keyword">this</span>.arg1 = arg1;</div><div class="line">        <span class="keyword">this</span>.arg2 = arg2;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">        System.out.println(&quot;Job ran at=&quot; + <span class="keyword">new</span> Date() + &quot;, with arg1=&quot; + arg1 + &quot; and arg2=&quot; + arg2);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>We have using this solution in production for quite sometime, and this has been pretty stable. </p>
<p>BTW, you can grab the source here: <a href="https://github.com/anismiles/jesque" target="_blank" rel="external">https://github.com/anismiles/jesque</a> and give it a try yourself. </p>
<p>Happy Hacking!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://47billion.com/blog/2013/09/02/delayed-jobs-with-jesque/" data-id="mnspbom7b66qav0n" class="article-share-link">Share</a>
      
        <a href="http://47billion.com/blog/2013/09/02/delayed-jobs-with-jesque/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Delayed-Job/">Delayed Job</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Jesque/">Jesque</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Quartz/">Quartz</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Redis/">Redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Resque/">Resque</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
</section>
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
        47Billion &copy; 2015
    </div>
  </div>
</footer>
    </div>
    
<script>
  var disqus_shortname = '47Billion';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/blog/js/jquery.min.js" type="text/javascript"></script>

<script src="/blog/js/jquery.scrollLoading.js" type="text/javascript"></script>



  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/blog/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/blog/js/script.js" type="text/javascript"></script>

<script src="/blog/js/jquery.slicknav.js" type="text/javascript"></script>

<script type="text/javascript">
    $(document).ready(function(){
        $('#sidebar').slicknav();
    });
</script>
  </div>
</body>
</html>